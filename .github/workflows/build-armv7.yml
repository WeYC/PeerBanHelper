name: Build ARMv7 image and sqlite-native

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-sqlite-and-m2:
    name: Build sqlite-jdbc (linux/arm/v7) and produce m2-local-repo
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup QEMU (register emulation)
        uses: docker/setup-qemu-action@v2

      - name: Setup docker buildx
        uses: docker/setup-buildx-action@v2

      - name: Ensure dirs exist
        run: |
          mkdir -p lib m2-local-repo devScripts

      - name: Build sqlite-jdbc for linux/arm/v7 (in arm container via QEMU)
        run: |
          # 在 arm 容器中运行仓库内的脚本来构建并把 jar 安装进 m2-local-repo
          docker run --rm --platform=linux/arm/v7 \
            -v "${{ github.workspace }}:/work" -w /work \
            --env DEBIAN_FRONTEND=noninteractive \
            arm32v7/debian:bookworm-slim bash -c "\
              apt-get update && apt-get install -y git build-essential default-jdk maven automake libtool pkg-config sqlite3 libsqlite3-dev ca-certificates && \
              chmod +x /work/devScripts/build-sqlite-armv7.sh && /work/devScripts/build-sqlite-armv7.sh \
            "

      - name: Show lib and m2-local-repo
        run: |
          echo 'lib:' && ls -la lib || true
          echo 'm2-local-repo:' && ls -la m2-local-repo || true

      - name: Upload m2-local-repo artifact
        uses: actions/upload-artifact@v4
        with:
          name: m2-local-repo
          path: m2-local-repo

  build-and-push-image:
    name: Build Docker image for linux/arm/v7 (uses m2-local-repo)
    runs-on: ubuntu-latest
    needs: build-sqlite-and-m2
    permissions:
      contents: read
    env:
      IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/peerbanhelper
      IMAGE_TAG: armv7-${{ github.sha }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download m2-local-repo artifact
        uses: actions/download-artifact@v4
        with:
          name: m2-local-repo
          path: m2-local-repo

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v2

      - name: Setup buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to registry (for pushing to GHCR)
        if: ${{ secrets.GHCR_PAT != '' }}
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Build and push/load linux/arm/v7 image
        run: |
          set -euo pipefail
          # Dockerfile expects m2-local-repo at repo root; we downloaded it above.
          DOCKER_BUILDX_FLAGS="--platform=linux/arm/v7"
          if [ "${{ secrets.GHCR_PAT }}" != '' ]; then
            docker buildx build ${DOCKER_BUILDX_FLAGS} --file Dockerfile --tag ${IMAGE_NAME}:${IMAGE_TAG} --push .
          else
            docker buildx build ${DOCKER_BUILDX_FLAGS} --file Dockerfile --tag ${IMAGE_NAME}:${IMAGE_TAG} --load .
          fi

      - name: Show built image (local)
        run: docker images | grep peerbanhelper || true
